syntax = "proto3";

package auth.v1;

option go_package = "github.com/yourcompany/shared-protos/generated/go/auth/v1";

import "common/types.proto";

service AuthService {

  // ============================================================================
  // ОТКРЫТЫЕ МЕТОДЫ - РЕГИСТРАЦИЯ И АВТОРИЗАЦИЯ
  // ============================================================================
  
  // Регистрация клиента (шаг 1) - отправка SMS с кодом
  rpc RegisterCustomerSendSMS(RegisterCustomerSendSMSRequest) returns (RegisterCustomerSendSMSResponse);
  
  // Регистрация клиента (шаг 2) - подтверждение кода из SMS
  rpc RegisterCustomerVerifySMS(RegisterCustomerVerifySMSRequest) returns (RegisterCustomerVerifySMSResponse);
  
  // Регистрация админа (шаг 1) - отправка кода на email
  rpc RegisterAdminSendEmail(RegisterAdminSendEmailRequest) returns (RegisterAdminSendEmailResponse);
  
  // Регистрация админа (шаг 2) - подтверждение кода из email
  rpc RegisterAdminVerifyEmail(RegisterAdminVerifyEmailRequest) returns (RegisterAdminVerifyEmailResponse);
  
  // Вход клиента (шаг 1) - отправка SMS с кодом
  rpc LoginCustomerSendSMS(LoginCustomerSendSMSRequest) returns (LoginCustomerSendSMSResponse);
  
  // Вход клиента (шаг 2) - подтверждение кода из SMS
  rpc LoginCustomerVerifySMS(LoginCustomerVerifySMSRequest) returns (LoginCustomerVerifySMSResponse);
  
  // Вход клиента через временный пароль (без SMS)
  rpc LoginCustomerWithTempPassword(LoginCustomerWithTempPasswordRequest) returns (LoginCustomerWithTempPasswordResponse);
  
  // Вход админа через email и пароль
  rpc LoginAdmin(LoginAdminRequest) returns (LoginAdminResponse);
  
  // ============================================================================
  // ЗАЩИЩЕННЫЕ МЕТОДЫ - ОБЩИЕ
  // ============================================================================
  
  // Выход пользователя
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  
  // Обновление access токена
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  
  // Валидация токена (для Gateway)
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
  
  // Получение информации о текущем пользователе
  rpc GetMyProfile(GetMyProfileRequest) returns (GetMyProfileResponse);
  
  // ============================================================================
  // ЗАЩИЩЕННЫЕ МЕТОДЫ - КЛИЕНТ
  // ============================================================================
  
  // Редактирование профиля клиента
  rpc UpdateCustomerProfile(UpdateCustomerProfileRequest) returns (UpdateCustomerProfileResponse);
  
  // Обновление настроек клиента
  rpc UpdateCustomerSettings(UpdateCustomerSettingsRequest) returns (UpdateCustomerSettingsResponse);
  
  // Удаление аккаунта клиентом
  rpc DeleteMyAccount(DeleteMyAccountRequest) returns (DeleteMyAccountResponse);
  
  // ============================================================================
  // ЗАЩИЩЕННЫЕ МЕТОДЫ - АДМИН
  // ============================================================================
  
  // Получение списка всех пользователей
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  
  // Получение информации о пользователе по ID
  rpc GetUserById(GetUserByIdRequest) returns (GetUserByIdResponse);
  
  // Создание админа/оператора/менеджера супер-админом
  rpc CreateStaffUser(CreateStaffUserRequest) returns (CreateStaffUserResponse);
  
  // Блокировка пользователя
  rpc BanUser(BanUserRequest) returns (BanUserResponse);
  
  // Разблокировка пользователя
  rpc UnbanUser(UnbanUserRequest) returns (UnbanUserResponse);
  
  // Назначение временного пароля для клиента
  rpc SetTemporaryPassword(SetTemporaryPasswordRequest) returns (SetTemporaryPasswordResponse);
  
  // Изменение роли пользователя
  rpc ChangeUserRole(ChangeUserRoleRequest) returns (ChangeUserRoleResponse);
  
}

// ============================================================================
// РЕГИСТРАЦИЯ КЛИЕНТА
// ============================================================================

message RegisterCustomerSendSMSRequest {
  uint64 phone = 1;                   // Номер телефона (числовой формат)
  string firstname = 2;               // Имя
  string lastname = 3;                // Фамилия
  string middlename = 4;              // Отчество
  Gender gender = 5;                  // Пол
  string email = 6;                   // Email (опционально)
}

message RegisterCustomerSendSMSResponse {
  string verification_id = 1;         // ID верификации для следующего шага
  int32 code_expires_in = 2;          // Время жизни кода в секундах
}

message RegisterCustomerVerifySMSRequest {
  string verification_id = 1;         // ID верификации из предыдущего шага
  string code = 2;                    // Код из SMS
}

message RegisterCustomerVerifySMSResponse {
  User user = 1;                      // Созданный пользователь
  string access_token = 2;            // JWT access token (содержит session_id внутри)
  string refresh_token = 3;           // JWT refresh token
}

// ============================================================================
// РЕГИСТРАЦИЯ АДМИНА
// ============================================================================

message RegisterAdminSendEmailRequest {
  string email = 1;                   // Email
  string password = 2;                // Пароль
  string firstname = 3;               // Имя
  string lastname = 4;                // Фамилия
  string middlename = 5;              // Отчество
}

message RegisterAdminSendEmailResponse {
  string verification_id = 1;         // ID верификации
  int32 code_expires_in = 2;          // Время жизни кода в секундах
}

message RegisterAdminVerifyEmailRequest {
  string verification_id = 1;         // ID верификации
  string code = 2;                    // Код из email
}

message RegisterAdminVerifyEmailResponse {
  User user = 1;                      // Созданный админ
  string access_token = 2;            // JWT access token (содержит session_id внутри)
  string refresh_token = 3;           // JWT refresh token
}

// ============================================================================
// ВХОД КЛИЕНТА
// ============================================================================

message LoginCustomerSendSMSRequest {
  uint64 phone = 1;                   // Номер телефона (числовой формат)
}

message LoginCustomerSendSMSResponse {
  string verification_id = 1;         // ID верификации
  int32 code_expires_in = 2;          // Время жизни кода в секундах
}

message LoginCustomerVerifySMSRequest {
  string verification_id = 1;         // ID верификации
  string code = 2;                    // Код из SMS
}

message LoginCustomerVerifySMSResponse {
  User user = 1;                      // Информация о пользователе
  string access_token = 2;            // JWT access token (содержит session_id внутри)
  string refresh_token = 3;           // JWT refresh token
}

message LoginCustomerWithTempPasswordRequest {
  uint64 phone = 1;                   // Номер телефона (числовой формат)
  string temp_password = 2;           // Временный пароль
}

message LoginCustomerWithTempPasswordResponse {
  User user = 1;                      // Информация о пользователе
  string access_token = 2;            // JWT access token (содержит session_id внутри)
  string refresh_token = 3;           // JWT refresh token
}

// ============================================================================
// ВХОД АДМИНА
// ============================================================================

message LoginAdminRequest {
  string email = 1;                   // Email
  string password = 2;                // Пароль
}

message LoginAdminResponse {
  User user = 1;                      // Информация об админе
  string access_token = 2;            // JWT access token (содержит session_id внутри)
  string refresh_token = 3;           // JWT refresh token
}

// ============================================================================
// ОБЩИЕ МЕТОДЫ
// ============================================================================

message LogoutRequest {
  // session_id извлекается из access_token на сервере
}

message LogoutResponse {
  bool success = 1;                   // Успешность операции
  string message = 2;                 // Сообщение
}

message RefreshTokenRequest {
  string refresh_token = 1;           // Refresh token
}

message RefreshTokenResponse {
  string access_token = 1;            // Новый access token
  string refresh_token = 2;           // Новый refresh token
}

message ValidateTokenRequest {
  string access_token = 1;            // Access token
}

message ValidateTokenResponse {
  bool valid = 1;                     // Валидность токена
  uint64 id_user = 2;                 // ID пользователя (числовой)
  uint64 phone = 3;                   // Телефон (для клиента, числовой)
  string email = 4;                   // Email (для админа)
  UserRole role = 5;                  // Роль пользователя
  // session_id находится внутри токена и не нужен клиенту
}

message GetMyProfileRequest {
  uint64 id_user = 1;                 // ID пользователя из токена
}

message GetMyProfileResponse {
  User user = 1;                      // Информация о пользователе
}

// ============================================================================
// МЕТОДЫ КЛИЕНТА
// ============================================================================

message UpdateCustomerProfileRequest {
  uint64 id_user = 1;                 // ID пользователя
  string firstname = 2;               // Имя
  string lastname = 3;                // Фамилия
  string middlename = 4;              // Отчество
  Gender gender = 5;                  // Пол
  string email = 6;                   // Email
  string avatar_url = 7;              // URL аватара
  string date_of_birth = 8;           // Дата рождения (YYYY-MM-DD)
  int32 city_id = 9;                  // ID города из справочника
  int32 region_id = 10;               // ID региона из справочника
}

message UpdateCustomerProfileResponse {
  User user = 1;                      // Обновленный пользователь
}

message UpdateCustomerSettingsRequest {
  uint64 id_user = 1;                 // ID пользователя
  CustomerSettings settings = 2;      // Настройки
}

message UpdateCustomerSettingsResponse {
  bool success = 1;                   // Успешность операции
  CustomerSettings settings = 2;      // Обновленные настройки
}

message DeleteMyAccountRequest {
  uint64 id_user = 1;                 // ID пользователя
  string reason = 2;                  // Причина удаления
}

message DeleteMyAccountResponse {
  bool success = 1;                   // Успешность операции
  string message = 2;                 // Сообщение
}

// ============================================================================
// АДМИНИСТРАТИВНЫЕ МЕТОДЫ
// ============================================================================

message ListUsersRequest {
  int32 page = 1;                     // Страница
  int32 limit = 2;                    // Количество на странице
  string search = 3;                  // Поисковый запрос
  string sort_by = 4;                 // Поле сортировки
  string order = 5;                   // Порядок (asc/desc)
  UserRole role_filter = 6;           // Фильтр по роли
  UserStatus status_filter = 7;       // Фильтр по статусу
  string created_from = 8;            // Дата создания от
  string created_to = 9;              // Дата создания до
}

message ListUsersResponse {
  repeated User users = 1;            // Список пользователей
  int32 total = 2;                    // Общее количество
  int32 page = 3;                     // Текущая страница
  int32 limit = 4;                    // Количество на странице
}

message GetUserByIdRequest {
  uint64 id_user = 1;                 // ID пользователя
}

message GetUserByIdResponse {
  User user = 1;                      // Информация о пользователе
}

message CreateStaffUserRequest {
  string email = 1;                   // Email
  string password = 2;                // Пароль
  string firstname = 3;               // Имя
  string lastname = 4;                // Фамилия
  string middlename = 5;              // Отчество
  UserRole role = 6;                  // Роль (админ/оператор/менеджер)
  uint64 phone = 7;                   // Телефон (опционально, числовой формат)
}

message CreateStaffUserResponse {
  User user = 1;                      // Созданный пользователь
}

message BanUserRequest {
  uint64 id_user = 1;                 // ID пользователя
  BanReason reason = 2;               // Причина блокировки
  string comment = 3;                 // Комментарий (опционально)
}

message BanUserResponse {
  bool success = 1;                   // Успешность операции
  User user = 2;                      // Обновленный пользователь
}

message UnbanUserRequest {
  uint64 id_user = 1;                 // ID пользователя
  string comment = 2;                 // Комментарий (опционально)
}

message UnbanUserResponse {
  bool success = 1;                   // Успешность операции
  User user = 2;                      // Обновленный пользователь
}

message SetTemporaryPasswordRequest {
  uint64 id_user = 1;                 // ID пользователя (клиента)
  string temp_password = 2;           // Временный пароль (генерируется автоматически если пустой)
  int32 expires_in_minutes = 3;       // Срок действия в минутах (по умолчанию 30)
}

message SetTemporaryPasswordResponse {
  bool success = 1;                   // Успешность операции
  string temp_password = 2;           // Временный пароль
  common.Timestamp expires_at = 3;    // Дата истечения
}

message ChangeUserRoleRequest {
  uint64 id_user = 1;                 // ID пользователя
  UserRole new_role = 2;              // Новая роль
}

message ChangeUserRoleResponse {
  bool success = 1;                   // Успешность операции
  User user = 2;                      // Обновленный пользователь
}

// ============================================================================
// МОДЕЛИ ДАННЫХ
// ============================================================================

message User {
  uint64 id_user = 1;                 // ID пользователя (числовой для быстрой обработки)
  uint64 phone = 2;                   // Телефон в числовом формате (для клиента)
  string email = 3;                   // Email
  string firstname = 4;               // Имя
  string lastname = 5;                // Фамилия
  string middlename = 6;              // Отчество
  Gender gender = 7;                  // Пол
  UserRole role = 8;                  // Роль
  UserStatus status = 9;              // Статус
  string avatar_url = 10;             // URL аватара
  string date_of_birth = 11;          // Дата рождения (YYYY-MM-DD)
  int32 city_id = 12;                 // ID города из справочника
  int32 region_id = 13;               // ID региона из справочника
  CustomerSettings settings = 14;     // Настройки (только для клиентов)
  common.Timestamp created_at = 15;   // Дата создания
  common.Timestamp updated_at = 16;   // Дата обновления
  common.Timestamp last_login = 17;   // Последний вход
}

message CustomerSettings {
  bool push_notifications = 1;        // Push уведомления
  bool email_notifications = 2;       // Email уведомления
  bool sms_notifications = 3;         // SMS уведомления
  bool marketing_emails = 4;          // Маркетинговые рассылки
  bool marketing_sms = 5;             // Маркетинговые SMS
  bool order_updates = 6;             // Уведомления о заказах
  bool promotional_offers = 7;        // Промо-акции
  string language = 8;                // Язык (ru/en/kk)
  string timezone = 9;                // Часовой пояс
}

// ============================================================================
// ENUMS
// ============================================================================

enum Gender {
  GENDER_UNSPECIFIED = 0;             // Не указан
  GENDER_MALE = 1;                    // Мужской
  GENDER_FEMALE = 2;                  // Женский
}

enum UserRole {
  USER_ROLE_UNSPECIFIED = 0;          // Не указано
  USER_ROLE_CUSTOMER = 1;             // Клиент
  USER_ROLE_OPERATOR = 2;             // Оператор
  USER_ROLE_MANAGER = 3;              // Менеджер
  USER_ROLE_ADMIN = 4;                // Администратор
  USER_ROLE_SUPER_ADMIN = 5;          // Супер-администратор
}

enum UserStatus {
  USER_STATUS_UNSPECIFIED = 0;        // Не указано
  USER_STATUS_ACTIVE = 1;             // Активный
  USER_STATUS_INACTIVE = 2;           // Неактивный
  USER_STATUS_BANNED = 3;             // Заблокирован
  USER_STATUS_DELETED = 4;            // Удален
}

enum BanReason {
  BAN_REASON_UNSPECIFIED = 0;                 // Не указано
  BAN_REASON_THEFT_RETAIL_STORE = 1;          // Кража на торговой точке
  BAN_REASON_THEFT_NIGHT_STORE = 2;           // Кража в ночном магазине
  BAN_REASON_THEFT_MICROMARKET = 3;           // Кража в микромаркете
  BAN_REASON_INSULT = 4;                      // Оскорбление
  BAN_REASON_PROPERTY_DAMAGE = 5;             // Порча имущества
  BAN_REASON_PERSONAL_INITIATIVE = 6;         // Личная инициатива
}
